name: Test actions-updater skill

on:
  workflow_dispatch:

jobs:
  test-updater:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Download test workflow file
        run: |
          mkdir -p test-workflows
          curl -sL "https://raw.githubusercontent.com/charliermarsh/autobot/e42c66659bf97b90ca9ff305a19cc99952d0d43f/.github/workflows/ci.yaml" -o test-workflows/ci.yaml

      - name: Update actions with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Use the actions-updater skill to check for outdated GitHub Actions
            in test-workflows/ci.yaml and update them.

            Run: uv run actions-updater/scripts/check_updates.py test-workflows/ci.yaml

            Then update any outdated actions in the file following the version
            format rules from the actions-updater skill.
          claude_args: |
            --allowedTools "Read,Edit,Bash(uv:*),Bash(gh:*)"
          plugin_marketplaces: |
            https://github.com/kaihendry/skills.git
          plugins: |
            github-skills@hendry-skills

      - name: Verify updates
        run: |
          echo "=== Verifying actions were updated ==="
          PASS=0
          FAIL=0

          check() {
            local label="$1" pattern="$2" file="test-workflows/ci.yaml"
            if grep -qE "$pattern" "$file"; then
              echo "PASS: $label"
              PASS=$((PASS + 1))
            else
              echo "FAIL: $label"
              grep "$3" "$file" || true
              FAIL=$((FAIL + 1))
            fi
          }

          check "actions/checkout updated from v3" \
            "uses: actions/checkout@v[4-9]" \
            "actions/checkout"

          check "actions/setup-python updated from v4" \
            "uses: actions/setup-python@v[5-9]" \
            "actions/setup-python"

          check "astral-sh/setup-uv updated from v1" \
            "uses: astral-sh/setup-uv@v[2-9]" \
            "astral-sh/setup-uv"

          echo ""
          echo "=== Results: $PASS passed, $FAIL failed ==="

          if [ "$FAIL" -gt 0 ]; then
            echo ""
            echo "--- Updated file contents ---"
            cat test-workflows/ci.yaml
            exit 1
          fi
